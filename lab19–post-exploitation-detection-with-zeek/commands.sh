# ================================
# Lab 19 â€“ Post-Exploitation Detection with Zeek
# commands.sh
# ================================

# --------------------------------
# Task 1: Install and Configure Zeek
# --------------------------------

sudo apt update && sudo apt upgrade -y

sudo apt install -y curl gnupg lsb-release

echo "deb http://download.opensuse.org/repositories/security:/zeek/xUbuntu_24.04/ /" | \
sudo tee /etc/apt/sources.list.d/security:zeek.list

curl -fsSL https://download.opensuse.org/repositories/security:zeek/xUbuntu_24.04/Release.key | \
gpg --dearmor | sudo tee /etc/apt/trusted.gpg.d/security_zeek.gpg > /dev/null

sudo apt update

sudo apt install -y zeek zeek-aux

/opt/zeek/bin/zeek --version

echo 'export PATH=/opt/zeek/bin:$PATH' >> ~/.bashrc

source ~/.bashrc

# --------------------------------
# Create Lab Directory Structure
# --------------------------------

mkdir -p ~/zeek-lab/{scripts,logs,pcaps,analysis}

cd ~/zeek-lab

# --------------------------------
# Configure Zeek Standalone Node
# --------------------------------

sudo nano /opt/zeek/etc/node.cfg

# Content added:
# [zeek]
# type=standalone
# host=localhost
# interface=lo

sudo nano /opt/zeek/etc/networks.cfg

# Content added:
# 10.0.0.0/8 Private
# 172.16.0.0/12 Private
# 192.168.0.0/16 Private
# 127.0.0.0/8 Loopback

# --------------------------------
# Test Zeek with Sample Traffic
# --------------------------------

curl -s http://example.com > /dev/null &

sudo timeout 10 tcpdump -i lo -w ~/zeek-lab/pcaps/test.pcap port 80

cd logs

zeek -r ~/zeek-lab/pcaps/test.pcap

ls -lh *.log

# --------------------------------
# Task 2: Create Custom Detection Scripts
# --------------------------------

cd ~/zeek-lab

nano scripts/unusual-connections.zeek

nano scripts/c2-detection.zeek

nano scripts/data-exfiltration.zeek

# --------------------------------
# Task 3: Generate Test Traffic
# --------------------------------

nano scripts/generate-traffic.sh

chmod +x scripts/generate-traffic.sh

sudo tcpdump -i lo -w ~/zeek-lab/pcaps/test-traffic.pcap &

TCPDUMP_PID=$!

./scripts/generate-traffic.sh

sleep 120

sudo kill $TCPDUMP_PID

# --------------------------------
# Run Zeek with Custom Scripts
# --------------------------------

cd analysis

zeek -r ~/zeek-lab/pcaps/test-traffic.pcap \
~/zeek-lab/scripts/unusual-connections.zeek \
~/zeek-lab/scripts/c2-detection.zeek \
~/zeek-lab/scripts/data-exfiltration.zeek

ls -lh *.log

cat notice.log

# --------------------------------
# Task 3.3: Log Analysis Script
# --------------------------------

cd ~/zeek-lab

nano scripts/analyze-logs.sh

chmod +x scripts/analyze-logs.sh

./scripts/analyze-logs.sh

# --------------------------------
# Task 4: Advanced Post-Exploitation Analysis
# --------------------------------

nano scripts/advanced-analysis.sh

chmod +x scripts/advanced-analysis.sh

./scripts/advanced-analysis.sh

# --------------------------------
# Create Executive Security Report
# --------------------------------

nano scripts/create-report.sh

chmod +x scripts/create-report.sh

./scripts/create-report.sh

cat ~/zeek-lab/analysis/security-report.txt

# --------------------------------
# Final Verification
# --------------------------------

zeek --version

ls -lh pcaps/

wc -l analysis/notice.log

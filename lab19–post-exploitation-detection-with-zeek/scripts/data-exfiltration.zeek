@load base/protocols/conn
@load base/protocols/http

module DataExfiltration;

export {

    const large_upload_threshold = 10000000 &redef; # 10MB
    const unusual_time_start = 18 &redef;
    const unusual_time_end = 6 &redef;

    global volume_tracker: table[addr] of count &default=0;
}

event connection_state_remove(c: connection)
{
    local src = c$id$orig_h;

    if ( c$orig_bytes > large_upload_threshold )
        NOTICE([$note=Notice::Sensitive_Activity,
                $msg=fmt("Large upload detected from %s", src),
                $src=src]);

    volume_tracker[src] += c$orig_bytes;
}

event http_entity_data(c: connection, is_orig: bool,
                       length: count, data: string)
{
    if ( is_orig )
    {
        if ( /password|credential|secret|token|key/i in data )
            NOTICE([$note=Notice::Sensitive_Activity,
                    $msg=fmt("Sensitive data exfiltration attempt from %s",
                             c$id$orig_h),
                    $src=c$id$orig_h]);
    }
}

event zeek_init()
{
    schedule 600secs { report_volumes() };
}

event report_volumes()
{
    for ( host in volume_tracker )
    {
        if ( volume_tracker[host] > large_upload_threshold )
            NOTICE([$note=Notice::Sensitive_Activity,
                    $msg=fmt("High cumulative upload volume from %s", host),
                    $src=host]);
    }

    schedule 600secs { report_volumes() };
}

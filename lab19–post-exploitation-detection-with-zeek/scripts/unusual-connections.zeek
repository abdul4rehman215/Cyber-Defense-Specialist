@load base/protocols/conn

module UnusualConnections;

export {

    const connection_threshold = 50 &redef;
    const port_scan_threshold = 20 &redef;
    const data_threshold = 1000000 &redef; # 1MB

    global connection_counts: table[addr] of count &default=0;
    global port_counts: table[addr] of set[port];
    global data_volumes: table[addr] of count &default=0;
}

event connection_state_remove(c: connection)
{
    local src = c$id$orig_h;
    local dst_port = c$id$resp_p;

    connection_counts[src] += 1;

    if ( src !in port_counts )
        port_counts[src] = set();

    add port_counts[src][dst_port];

    data_volumes[src] += c$orig_bytes + c$resp_bytes;

    if ( connection_counts[src] > connection_threshold )
        NOTICE([$note=Notice::Policy_Violation,
                $msg=fmt("High connection count from %s", src),
                $src=src]);

    if ( |port_counts[src]| > port_scan_threshold )
        NOTICE([$note=Notice::Port_Scan,
                $msg=fmt("Port scan detected from %s", src),
                $src=src]);

    if ( data_volumes[src] > data_threshold )
        NOTICE([$note=Notice::Sensitive_Activity,
                $msg=fmt("High data volume from %s", src),
                $src=src]);
}

event zeek_init()
{
    schedule 300secs { cleanup_tables() };
}

event cleanup_tables()
{
    connection_counts = table();
    port_counts = table();
    data_volumes = table();
    schedule 300secs { cleanup_tables() };
}

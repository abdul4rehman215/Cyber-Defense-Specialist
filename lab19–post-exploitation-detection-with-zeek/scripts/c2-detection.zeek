@load base/protocols/http
@load base/protocols/dns

module C2Detection;

export {

    const suspicious_domains = {"malware-c2.com", "evil-control.net"};
    const suspicious_user_agents = {"malware-bot", "evil-agent"};
    const beacon_threshold = 5 &redef;

    global beacon_counts: table[addr, addr] of count &default=0;
}

event http_request(c: connection, method: string,
                   original_URI: string,
                   unescaped_URI: string,
                   version: string)
{
    if ( c$http?$user_agent )
    {
        for ( ua in suspicious_user_agents )
        {
            if ( ua in c$http$user_agent )
                NOTICE([$note=Notice::Policy_Violation,
                        $msg=fmt("Suspicious User-Agent from %s", c$id$orig_h),
                        $src=c$id$orig_h]);
        }
    }

    if ( c$http?$host )
    {
        if ( c$http$host in suspicious_domains )
            NOTICE([$note=Notice::Sensitive_Activity,
                    $msg=fmt("C2 domain contacted: %s", c$http$host),
                    $src=c$id$orig_h]);
    }
}

event dns_request(c: connection, msg: dns_msg,
                  query: string, qtype: count, qclass: count)
{
    if ( query in suspicious_domains )
        NOTICE([$note=Notice::Sensitive_Activity,
                $msg=fmt("Suspicious DNS query: %s", query),
                $src=c$id$orig_h]);
}

event connection_established(c: connection)
{
    local src = c$id$orig_h;
    local dst = c$id$resp_h;

    beacon_counts[src, dst] += 1;

    if ( beacon_counts[src, dst] > beacon_threshold )
        NOTICE([$note=Notice::Sensitive_Activity,
                $msg=fmt("Possible beaconing between %s and %s", src, dst),
                $src=src]);
}

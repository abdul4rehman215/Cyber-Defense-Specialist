#!/bin/bash

REPORT_FILE=~/zeek-lab/analysis/security-report.txt
cd ~/zeek-lab/analysis || exit

echo "Security Analysis Report" > $REPORT_FILE
echo "Generated: $(date)" >> $REPORT_FILE
echo "===================================" >> $REPORT_FILE
echo "" >> $REPORT_FILE

echo "Executive Summary" >> $REPORT_FILE
echo "-----------------" >> $REPORT_FILE

TOTAL_CONN=$(wc -l < conn.log)
TOTAL_ALERTS=0
[ -f notice.log ] && TOTAL_ALERTS=$(wc -l < notice.log)

echo "Total Connections: $TOTAL_CONN" >> $REPORT_FILE
echo "Total Alerts: $TOTAL_ALERTS" >> $REPORT_FILE
echo "" >> $REPORT_FILE

echo "Detailed Findings" >> $REPORT_FILE
echo "-----------------" >> $REPORT_FILE

if [ -f notice.log ]; then
    zeek-cut ts note msg src dst < notice.log >> $REPORT_FILE
fi

echo "" >> $REPORT_FILE
echo "Top Talkers" >> $REPORT_FILE
zeek-cut id.orig_h < conn.log | sort | uniq -c | sort -nr | head >> $REPORT_FILE

echo "" >> $REPORT_FILE
echo "Protocol Distribution" >> $REPORT_FILE
zeek-cut proto < conn.log | sort | uniq -c >> $REPORT_FILE

echo "" >> $REPORT_FILE
echo "Data Volume Summary" >> $REPORT_FILE
zeek-cut orig_bytes resp_bytes < conn.log | \
awk '{sum1+=$1; sum2+=$2} END {print "Total Sent:",sum1,"Total Received:",sum2}' >> $REPORT_FILE

echo ""
echo "Report generated: $REPORT_FILE"

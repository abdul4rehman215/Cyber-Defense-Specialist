#!/bin/bash

cd ~/zeek-lab/analysis || exit

echo "=== POST-EXPLOITATION INDICATORS ==="

echo ""
echo "Lateral Movement (Admin Ports):"
zeek-cut id.orig_h id.resp_p < conn.log | \
awk '$2==22 || $2==3389 || $2==445 || $2==135'

echo ""
echo "Large Internal Transfers (>10MB):"
zeek-cut id.orig_h orig_bytes resp_bytes < conn.log | \
awk '$2 > 10000000 || $3 > 10000000'

echo ""
echo "C2 Repeated Connections:"
zeek-cut id.orig_h id.resp_h < conn.log | \
sort | uniq -c | sort -nr | head

echo ""
echo "Privilege Escalation Indicators:"
if [ -f http.log ]; then
    zeek-cut uri < http.log | grep -Ei "admin|root|sudo"
fi

echo ""
echo "Persistence Indicators (Executable Downloads):"
if [ -f http.log ]; then
    zeek-cut uri < http.log | grep -Ei "\.exe|\.bat|\.ps1|\.sh"
fi

echo ""
echo "Exfiltration (Top 10 Largest Transfers):"
zeek-cut id.orig_h orig_bytes < conn.log | \
sort -k2 -nr | head -10

echo ""
echo "Activity Timeline:"
zeek-cut ts < conn.log | \
awk '{print strftime("%Y-%m-%d %H", $1)}' | \
sort | uniq -c

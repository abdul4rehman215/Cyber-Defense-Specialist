#!/bin/bash

# ==========================================
# LAB 5 â€“ DETECTING POST-EXPLOITATION TRAFFIC
# ==========================================


# -------------------------------
# Setup Working Directory
# -------------------------------

mkdir -p ~/lab5_post_exploitation
cd ~/lab5_post_exploitation
pwd


# -------------------------------
# LATERAL MOVEMENT SIMULATION
# -------------------------------

# Make script executable
chmod +x simulate_lateral_movement.py

# Run lateral movement simulation
python3 simulate_lateral_movement.py


# -------------------------------
# Capture Lateral Movement Traffic
# -------------------------------

sudo tcpdump -i lo -w lateral_movement.pcap &
TCPDUMP_PID=$!

# Re-run simulation while capturing
python3 simulate_lateral_movement.py

# Stop capture
sleep 10
sudo kill $TCPDUMP_PID

# Verify capture
ls -lh lateral_movement.pcap


# -------------------------------
# Analyze Lateral Movement Traffic
# -------------------------------

tcpdump -r lateral_movement.pcap -n | head -20

tcpdump -r lateral_movement.pcap -n port 445
tcpdump -r lateral_movement.pcap -n port 3389

tcpdump -r lateral_movement.pcap -n | awk '{print $3}' | sort | uniq -c | sort -nr


# -------------------------------
# C2 TRAFFIC SIMULATION
# -------------------------------

chmod +x simulate_c2_traffic.py


# Capture C2 traffic
sudo tcpdump -i lo -w c2_traffic.pcap &
TCPDUMP_PID=$!

# Run C2 simulation
python3 simulate_c2_traffic.py

# Stop capture
sleep 15
sudo kill $TCPDUMP_PID

# Verify capture
ls -lh c2_traffic.pcap


# -------------------------------
# Wireshark Analysis
# -------------------------------

wireshark c2_traffic.pcap &


# -------------------------------
# C2 DETECTION SCRIPT
# -------------------------------

chmod +x c2_detector.py
python3 c2_detector.py


# -------------------------------
# Comprehensive Attack Scenario
# -------------------------------

chmod +x comprehensive_scenario.py
python3 comprehensive_scenario.py

# Verify final capture
ls -lh comprehensive_attack.pcap


# ==========================================
# End of Lab 5 Commands
# ==========================================

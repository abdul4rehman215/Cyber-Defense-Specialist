#!/usr/bin/env python3
import socket
import time
import threading
import base64
import random
import urllib.request
import http.server
import socketserver

def simulate_http_c2():
    """Simulate HTTP-based C2 communication"""
    print("[+] Simulating HTTP C2 communication...")

    class C2Handler(http.server.SimpleHTTPRequestHandler):
        def do_GET(self):
            self.send_response(200)
            self.send_header('Content-type', 'text/plain')
            self.end_headers()

            if 'beacon' in self.path:
                response = base64.b64encode(b'{"cmd":"sleep","interval":60}').decode()
            else:
                response = base64.b64encode(b'{"status":"ok"}').decode()

            self.wfile.write(response.encode())

    PORT = 8080
    with socketserver.TCPServer(("", PORT), C2Handler) as httpd:
        server_thread = threading.Thread(target=httpd.serve_forever)
        server_thread.daemon = True
        server_thread.start()

        time.sleep(2)

        beacon_urls = [
            f"http://localhost:{PORT}/beacon?id=victim001",
            f"http://localhost:{PORT}/update?v=1.2",
            f"http://localhost:{PORT}/config?host=target"
        ]

        for url in beacon_urls:
            try:
                response = urllib.request.urlopen(url, timeout=5)
                response.read()
                print(f"[+] C2 beacon: {url}")
                time.sleep(random.uniform(2, 4))
            except:
                pass

        httpd.shutdown()

def simulate_encrypted_c2():
    """Simulate encrypted C2 over custom port"""
    print("[+] Simulating encrypted C2...")

    try:
        server_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        server_sock.bind(('localhost', 4444))
        server_sock.listen(1)
        server_sock.settimeout(10)

        client_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

        def server_handler():
            try:
                conn, addr = server_sock.accept()
                encrypted_data = base64.b64encode(b"encrypted_command_data").decode()
                conn.send(encrypted_data.encode())
                conn.close()
            except:
                pass

        server_thread = threading.Thread(target=server_handler)
        server_thread.start()

        time.sleep(1)

        try:
            client_sock.connect(('localhost', 4444))
            data = client_sock.recv(1024)
            print(f"[+] Received encrypted C2 data: {data.decode()[:50]}...")
            client_sock.close()
        except:
            pass

        server_thread.join(timeout=5)
        server_sock.close()

    except Exception as e:
        print(f"[-] Error in encrypted C2 simulation: {e}")

def main():
    print("=== C2 Communication Simulation ===")
    simulate_http_c2()
    time.sleep(5)
    simulate_encrypted_c2()
    print("[+] C2 simulation complete")

if __name__ == "__main__":
    main()

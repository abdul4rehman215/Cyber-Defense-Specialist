#!/usr/bin/env python3
import subprocess
import re
from collections import defaultdict

def analyze_pcap_file(pcap_file):
    print(f"[+] Analyzing {pcap_file} for C2 indicators...")
    cmd = f"tcpdump -r {pcap_file} -n -q"
    result = subprocess.run(cmd.split(), capture_output=True, text=True)

    connections = defaultdict(list)

    for line in result.stdout.split('\n'):
        if line.strip():
            parts = line.split()
            if len(parts) >= 3:
                connection = parts[2]
                if '>' in connection:
                    src, dst = connection.split('>', 1)
                    connections[dst.strip(':')].append(parts[0])

    return connections

def detect_beacon_behavior(connections):
    print("[+] Detecting beacon behavior...")
    suspicious_hosts = []
    for host, times in connections.items():
        if len(times) >= 3:
            print(f"[*] Host {host}: {len(times)} connections")
            suspicious_hosts.append(host)
    return suspicious_hosts

def detect_unusual_ports(pcap_file):
    print("[+] Detecting unusual port usage...")
    cmd = f"tcpdump -r {pcap_file} -n | grep -E ':[0-9]+' | grep -v ':80\\|:443\\|:53\\|:22\\|:21'"
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)

    unusual_ports = []
    for line in result.stdout.split('\n'):
        if line.strip():
            port_matches = re.findall(r':(\d+)', line)
            for port in port_matches:
                if int(port) > 1024 and int(port) not in [8080, 8443]:
                    unusual_ports.append(port)

    return list(set(unusual_ports))

def detect_base64_traffic(pcap_file):
    print("[+] Detecting base64 encoded traffic...")
    cmd = f"tcpdump -r {pcap_file} -A | grep -E '[A-Za-z0-9+/]{{20,}}=*'"
    result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
    return bool(result.stdout.strip())

def generate_report(pcap_file):
    print(f"\n=== C2 Detection Report for {pcap_file} ===")
    connections = analyze_pcap_file(pcap_file)
    suspicious_hosts = detect_beacon_behavior(connections)
    unusual_ports = detect_unusual_ports(pcap_file)
    has_base64 = detect_base64_traffic(pcap_file)

    print("\n[+] Analysis Results:")
    print(f" Total unique destinations: {len(connections)}")
    print(f" Suspicious beacon hosts: {len(suspicious_hosts)}")
    print(f" Unusual ports detected: {unusual_ports}")
    print(f" Base64 traffic detected: {has_base64}")

    risk_score = 0
    if suspicious_hosts:
        risk_score += 3
    if unusual_ports:
        risk_score += 2
    if has_base64:
        risk_score += 2

    print("\n[+] Risk Assessment:")
    if risk_score >= 5:
        print(" HIGH RISK - Multiple C2 indicators detected")
    elif risk_score >= 3:
        print(" MEDIUM RISK - Some C2 indicators present")
    else:
        print(" LOW RISK - Few or no C2 indicators")

def main():
    print("=== C2 Traffic Detection Tool ===")
    for file in ['lateral_movement.pcap', 'c2_traffic.pcap']:
        try:
            generate_report(file)
            print("=" * 50)
        except:
            print(f"[-] Could not analyze {file}")

if __name__ == "__main__":
    main()

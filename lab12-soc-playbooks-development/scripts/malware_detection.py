#!/usr/bin/env python3

import sys
import os
import psutil
import hashlib
import shutil
import time

sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from base_playbook import BasePlaybook


class MalwareDetectionPlaybook(BasePlaybook):

    def __init__(self):
        super().__init__("malware_detection", "high")
        self.suspicious_processes = []
        self.suspicious_files = []

    def scan_processes(self):

        for proc in psutil.process_iter(['pid', 'name', 'exe', 'cmdline']):
            try:
                exe = proc.info.get('exe') or ""
                cmdline = " ".join(proc.info.get('cmdline') or [])

                # Suspicious execution paths
                if "/tmp" in exe or "/dev/shm" in exe:
                    self.suspicious_processes.append(proc.info)

                # Reverse shell / netcat detection
                if "nc " in cmdline or "reverse" in cmdline:
                    self.suspicious_processes.append(proc.info)

            except Exception:
                continue

        self.log_action(
            "Scan Processes",
            "SUCCESS",
            f"Found {len(self.suspicious_processes)} suspicious processes"
        )

    def scan_files(self, scan_paths=['/tmp', '/var/tmp', '/dev/shm']):

        for path in scan_paths:
            if not os.path.exists(path):
                continue

            for root, _, files in os.walk(path):
                for file in files:
                    filepath = os.path.join(root, file)

                    try:
                        # Suspicious script extensions
                        if file.endswith(('.sh', '.py', '.pl')):
                            self.suspicious_files.append(filepath)

                        # World-writable file detection
                        if os.stat(filepath).st_mode & 0o002:
                            self.suspicious_files.append(filepath)

                    except Exception:
                        continue

        self.log_action(
            "Scan Files",
            "SUCCESS",
            f"Found {len(self.suspicious_files)} suspicious files"
        )

    def calculate_hash(self, filepath):

        sha256 = hashlib.sha256()

        try:
            with open(filepath, 'rb') as f:
                while chunk := f.read(4096):
                    sha256.update(chunk)

            return sha256.hexdigest()

        except Exception:
            return None

    def quarantine_file(self, filepath):

        quarantine_dir = f"logs/incidents/quarantine_{self.incident_id}"
        os.makedirs(quarantine_dir, exist_ok=True)

        filename = os.path.basename(filepath)
        new_path = os.path.join(quarantine_dir, filename)

        file_hash = self.calculate_hash(filepath)

        shutil.move(filepath, new_path)

        self.log_action(
            "Quarantine File",
            "SUCCESS",
            f"{filepath} -> {new_path} | Hash: {file_hash}"
        )

        return new_path

    def terminate_process(self, pid):

        try:
            proc = psutil.Process(pid)
            proc.terminate()
            time.sleep(1)

            if proc.is_running():
                proc.kill()

            self.log_action("Terminate Process", "SUCCESS", f"PID {pid}")
            return True

        except Exception as e:
            self.log_action("Terminate Process", "FAILED", str(e))
            return False

    def run(self):

        self.log_action("Playbook Start", "STARTED")

        self.scan_processes()
        self.scan_files()

        if self.suspicious_processes or self.suspicious_files:
            self.send_alert("Malware activity detected!", "high")

        for file in self.suspicious_files:
            self.quarantine_file(file)

        for proc in self.suspicious_processes:
            self.terminate_process(proc.get('pid'))

        report = self.generate_report()

        self.log_action("Playbook Complete", "SUCCESS", report)


if __name__ == "__main__":
    playbook = MalwareDetectionPlaybook()
    playbook.run()

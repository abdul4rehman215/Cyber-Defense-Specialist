# ğŸ§ª Lab 08 â€“ Malware Identification in Document Payloads

---

## ğŸ”¹ Environment

- **OS:** Ubuntu 24.04.1 LTS (Cloud EC2 â€“ Alnafi)
- **User:** toor
- **Interface:** ens5
- **Working Directory:** /home/toor/malware_analysis
- **Language Used:** Python 3.12
- **Sandbox Tool:** Firejail

---

## ğŸ¯ Objectives

By the end of this lab, students will be able to:

- Identify malicious payloads embedded inside document formats
- Detect suspicious keywords and macro indicators
- Perform MIME type detection
- Calculate MD5 and SHA256 file hashes
- Implement batch document scanning
- Configure sandboxed execution using Firejail
- Monitor runtime process and network activity
- Detect malicious patterns using regex-based analysis
- Generate structured JSON reports for all analysis modules

---

## ğŸ“Œ Prerequisites

Students should have:

- Basic Python programming knowledge
- Familiarity with Linux CLI
- Understanding of document formats (PDF, DOCX, XLSX, TXT)
- Basic cybersecurity and malware analysis concepts

---

# ğŸ›  Lab Tasks Overview

---

## ğŸ”¹ Task 1: Environment Setup

- Verified Python installation
- Upgraded pip
- Installed required Python libraries:
  - oletools
  - python-magic
  - pdfplumber
  - docx2txt
  - psutil
- Installed system dependencies:
  - firejail
  - libmagic1
- Created structured working directory:
  ```
  malware_analysis/
  â”œâ”€â”€ samples/
  â”œâ”€â”€ scripts/
  â”œâ”€â”€ results/
  â””â”€â”€ logs/
  ```
- Created suspicious test sample for analysis

---

## ğŸ”¹ Task 2: Static Document Analysis

Developed:

- `document_scanner.py`
  - File metadata extraction
  - Hash generation (MD5 / SHA256)
  - MIME detection
  - Office macro detection (oletools)
  - PDF suspicious content scanning
  - Risk scoring engine
  - JSON report generation

- `batch_scanner.py`
  - Recursive document discovery
  - Multi-file scanning
  - Risk distribution summary
  - Batch JSON report generation

Validated:
- Single file scan
- Batch directory scan

---

## ğŸ”¹ Task 3: Sandboxed & Dynamic Analysis

Configured:

- Firejail restricted profile
- Isolated execution environment
- Read-only system libraries
- No network access
- Capability dropping

Developed:

- `sandboxed_analyzer.py`
  - Secure document execution inside Firejail
  - Captures stdout, stderr, return codes
  - Generates sandbox JSON report

- `dynamic_monitor.py`
  - Captures process baseline
  - Detects newly spawned processes
  - Monitors active network connections
  - Generates dynamic behavior report

---

## ğŸ”¹ Task 4: Pattern-Based Malware Detection

Developed:

- `pattern_analyzer.py`
  - Regex detection of:
    - Obfuscation techniques
    - Execution patterns
    - Download behaviors
  - Risk scoring system
  - JSON reporting

Tested using obfuscated macro-like content.

---

# ğŸ“Š Results Generated

The lab produces structured reports:

- Static analysis reports
- Batch scan summaries
- Sandboxed execution reports
- Dynamic monitoring reports
- Pattern detection reports

All stored under:

```
~/malware_analysis/results/
```

---

# ğŸ“‚ Files Included

```
lab08-malware-identification-document-payloads/
â”œâ”€â”€ README.md
â”œâ”€â”€ commands.sh
â”œâ”€â”€ output.txt
â”œâ”€â”€ interview.md
â”œâ”€â”€ troubleshooting.md
â””â”€â”€ scripts/
    â”œâ”€â”€ document_scanner.py
    â”œâ”€â”€ batch_scanner.py
    â”œâ”€â”€ sandboxed_analyzer.py
    â”œâ”€â”€ dynamic_monitor.py
    â””â”€â”€ pattern_analyzer.py
```

---

# ğŸ” Key Security Insight

Never open suspicious documents directly on a host system.

Always combine:

- Static analysis (hashes, keywords, macros)
- Pattern detection
- Sandboxed execution
- Dynamic behavior monitoring

Isolation + automation significantly reduces risk during malware investigation.

---

# ğŸ Conclusion

This lab demonstrated a complete document malware analysis workflow combining:

- Static scanning
- Hash verification
- Macro inspection
- Batch automation
- Sandboxed execution
- Dynamic process monitoring
- Pattern-based detection
- Structured JSON reporting

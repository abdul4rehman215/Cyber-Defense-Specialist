#!/usr/bin/env python3

import os
import sys
import hashlib
import json
import magic
from datetime import datetime


class DocumentScanner:

    def __init__(self):
        self.suspicious_keywords = [
            'Shell', 'CreateObject', 'WScript', 'cmd.exe', 'powershell',
            'Download', 'Execute', 'AutoOpen', 'Workbook_Open',
            'URLDownloadToFile', 'WinExec'
        ]

        self.results = {
            'file_info': {},
            'macro_analysis': {},
            'suspicious_content': [],
            'risk_score': 0,
            'risk_level': ''
        }

    def calculate_file_hash(self, filepath):

        md5_hash = hashlib.md5()
        sha256_hash = hashlib.sha256()

        with open(filepath, "rb") as f:
            while chunk := f.read(4096):
                md5_hash.update(chunk)
                sha256_hash.update(chunk)

        return {
            "md5": md5_hash.hexdigest(),
            "sha256": sha256_hash.hexdigest()
        }

    def get_file_info(self, filepath):

        stat_info = os.stat(filepath)
        mime = magic.Magic(mime=True)
        file_type = mime.from_file(filepath)

        hashes = self.calculate_file_hash(filepath)

        self.results['file_info'] = {
            "filename": os.path.basename(filepath),
            "size": stat_info.st_size,
            "mime_type": file_type,
            "md5": hashes["md5"],
            "sha256": hashes["sha256"]
        }

    def analyze_office_document(self, filepath):

        try:
            from oletools.olevba import VBA_Parser

            vbaparser = VBA_Parser(filepath)
            macros = []

            if vbaparser.detect_vba_macros():
                for (_, _, _, vba_code) in vbaparser.extract_macros():
                    macros.append(vba_code)

                    for keyword in self.suspicious_keywords:
                        if keyword.lower() in vba_code.lower():
                            self.results['suspicious_content'].append(keyword)
                            self.results['risk_score'] += 10

                self.results['macro_analysis'] = {
                    "macros_detected": True,
                    "macro_count": len(macros)
                }
            else:
                self.results['macro_analysis'] = {
                    "macros_detected": False
                }

            vbaparser.close()

        except Exception as e:
            self.results['macro_analysis'] = {"error": str(e)}

    def analyze_pdf_document(self, filepath):

        try:
            import pdfplumber

            suspicious_pdf_keywords = ['JavaScript', '/JS', '/OpenAction', 'eval']

            with pdfplumber.open(filepath) as pdf:
                for page in pdf.pages:
                    text = page.extract_text()
                    if text:
                        for keyword in suspicious_pdf_keywords:
                            if keyword.lower() in text.lower():
                                self.results['suspicious_content'].append(keyword)
                                self.results['risk_score'] += 15

        except Exception as e:
            print(f"[!] Error analyzing PDF: {str(e)}")

    def calculate_risk_level(self):

        score = self.results['risk_score']

        if score >= 50:
            return "HIGH"
        elif score >= 25:
            return "MEDIUM"
        else:
            return "LOW"

    def scan_document(self, filepath):

        if not os.path.exists(filepath):
            print("File not found.")
            sys.exit(1)

        self.get_file_info(filepath)

        mime_type = self.results['file_info']['mime_type']

        if "officedocument" in mime_type or "msword" in mime_type or "excel" in mime_type:
            self.analyze_office_document(filepath)

        elif "pdf" in mime_type:
            self.analyze_pdf_document(filepath)

        else:
            with open(filepath, "r", errors="ignore") as f:
                content = f.read()
                for keyword in self.suspicious_keywords:
                    if keyword.lower() in content.lower():
                        self.results['suspicious_content'].append(keyword)
                        self.results['risk_score'] += 5

        self.results['risk_level'] = self.calculate_risk_level()

        return self.results

    def generate_report(self, output_file):

        report = {
            "timestamp": datetime.now().isoformat(),
            "scan_results": self.results
        }

        with open(output_file, "w") as f:
            json.dump(report, f, indent=4)


def main():

    if len(sys.argv) != 2:
        print("Usage: python3 document_scanner.py <document_path>")
        sys.exit(1)

    document_path = sys.argv[1]

    scanner = DocumentScanner()
    results = scanner.scan_document(document_path)

    print("\nScan Summary:")
    print(json.dumps(results, indent=4))

    output_path = os.path.expanduser(
        f"~/malware_analysis/results/report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    )

    scanner.generate_report(output_path)

    print(f"\nReport saved to {output_path}")


if __name__ == "__main__":
    main()

#!/usr/bin/env python3

import os
import sys
import subprocess
import shutil
import json
from datetime import datetime


class SandboxedAnalyzer:

    def __init__(self):
        self.sandbox_dir = "/tmp/document_sandbox"
        self.results_dir = os.path.expanduser("~/malware_analysis/results")

    def setup_sandbox(self):

        if os.path.exists(self.sandbox_dir):
            shutil.rmtree(self.sandbox_dir)

        os.makedirs(self.sandbox_dir, mode=0o700)
        os.makedirs(os.path.join(self.sandbox_dir, "logs"), exist_ok=True)

    def copy_file_to_sandbox(self, source_file):

        if not os.path.exists(source_file):
            print("Source file not found.")
            sys.exit(1)

        destination = os.path.join(self.sandbox_dir, os.path.basename(source_file))
        shutil.copy2(source_file, destination)

        return destination

    def run_sandboxed_analysis(self, sandbox_file):

        command = [
            "firejail",
            "--profile=~/.config/firejail/document-analysis.profile",
            "python3",
            os.path.expanduser("~/malware_analysis/scripts/document_scanner.py"),
            sandbox_file
        ]

        try:
            result = subprocess.run(
                command,
                capture_output=True,
                text=True,
                timeout=300
            )

            return {
                "stdout": result.stdout,
                "stderr": result.stderr,
                "returncode": result.returncode
            }

        except subprocess.TimeoutExpired:
            return {"error": "Analysis timed out"}

    def cleanup_sandbox(self):

        if os.path.exists(self.sandbox_dir):
            shutil.rmtree(self.sandbox_dir)

    def analyze_document_safely(self, document_path):

        self.setup_sandbox()

        sandbox_file = self.copy_file_to_sandbox(document_path)

        analysis_result = self.run_sandboxed_analysis(sandbox_file)

        report = {
            "timestamp": datetime.now().isoformat(),
            "document": document_path,
            "sandbox_result": analysis_result
        }

        output_file = os.path.join(
            self.results_dir,
            f"sandbox_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        )

        with open(output_file, "w") as f:
            json.dump(report, f, indent=4)

        self.cleanup_sandbox()

        return report


def main():

    if len(sys.argv) != 2:
        print("Usage: python3 sandboxed_analyzer.py <document_path>")
        sys.exit(1)

    document_path = sys.argv[1]

    analyzer = SandboxedAnalyzer()
    result = analyzer.analyze_document_safely(document_path)

    print(json.dumps(result, indent=4))


if __name__ == "__main__":
    main()

#!/usr/bin/env python3

import re
import sys
import json
import os
from datetime import datetime


class PatternAnalyzer:

    def __init__(self):

        self.patterns = {
            'obfuscation': [
                r'Chr\(\d+\)',
                r'StrReverse\(',
                r'Replace\(.+,.+,.+\)'
            ],
            'execution': [
                r'Shell\s*\(',
                r'CreateObject\s*\(\s*["\']WScript\.Shell',
                r'\.Run\s*\('
            ],
            'download': [
                r'URLDownloadToFile',
                r'MSXML2\.XMLHTTP',
                r'WinHttp\.WinHttpRequest'
            ]
        }

    def analyze_code(self, code_content):

        findings = {}
        risk_score = 0

        lines = code_content.splitlines()

        for category, patterns in self.patterns.items():

            findings[category] = []

            for pattern in patterns:
                regex = re.compile(pattern, re.IGNORECASE)

                for line_number, line in enumerate(lines, start=1):
                    if regex.search(line):
                        findings[category].append({
                            "line": line_number,
                            "pattern": pattern,
                            "content": line.strip()
                        })
                        risk_score += 10

        return {
            "findings": findings,
            "risk_score": risk_score,
            "risk_level": self.calculate_risk_level(risk_score)
        }

    def calculate_risk_level(self, score):

        if score >= 50:
            return "HIGH"
        elif score >= 25:
            return "MEDIUM"
        else:
            return "LOW"


def main():

    if len(sys.argv) != 2:
        print("Usage: python3 pattern_analyzer.py <file_path>")
        sys.exit(1)

    file_path = sys.argv[1]

    if not os.path.exists(file_path):
        print("File not found.")
        sys.exit(1)

    with open(file_path, "r", errors="ignore") as f:
        content = f.read()

    analyzer = PatternAnalyzer()
    result = analyzer.analyze_code(content)

    report = {
        "timestamp": datetime.now().isoformat(),
        "file": file_path,
        "analysis": result
    }

    output_path = os.path.expanduser(
        f"~/malware_analysis/results/pattern_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    )

    with open(output_path, "w") as f:
        json.dump(report, f, indent=4)

    print(json.dumps(report, indent=4))
    print(f"\nReport saved to {output_path}")


if __name__ == "__main__":
    main()

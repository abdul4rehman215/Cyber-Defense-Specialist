#!/usr/bin/env python3

import os
import sys
import glob
import json
from datetime import datetime
from document_scanner import DocumentScanner


class BatchScanner:

    def __init__(self, directory_path):
        self.directory_path = directory_path
        self.supported_extensions = ['.doc', '.docx', '.xls', '.xlsx', '.pdf', '.txt']
        self.scan_results = []

    def find_documents(self):

        documents = []

        for ext in self.supported_extensions:
            pattern = os.path.join(self.directory_path, f"**/*{ext}")
            found = glob.glob(pattern, recursive=True)
            documents.extend(found)

        return documents

    def scan_all_documents(self):

        documents = self.find_documents()

        if not documents:
            print("No supported documents found.")
            return

        for doc in documents:
            print(f"\nScanning: {doc}")
            scanner = DocumentScanner()
            result = scanner.scan_document(doc)
            self.scan_results.append(result)

        self.generate_summary_report()

    def generate_summary_report(self):

        summary = {
            "timestamp": datetime.now().isoformat(),
            "total_files_scanned": len(self.scan_results),
            "high_risk": 0,
            "medium_risk": 0,
            "low_risk": 0,
            "files_with_macros": 0
        }

        for result in self.scan_results:
            level = result.get("risk_level")

            if level == "HIGH":
                summary["high_risk"] += 1
            elif level == "MEDIUM":
                summary["medium_risk"] += 1
            else:
                summary["low_risk"] += 1

            if result.get("macro_analysis", {}).get("macros_detected"):
                summary["files_with_macros"] += 1

        output_path = os.path.expanduser(
            f"~/malware_analysis/results/batch_summary_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        )

        with open(output_path, "w") as f:
            json.dump(summary, f, indent=4)

        print("\nBatch Scan Summary:")
        print(json.dumps(summary, indent=4))
        print(f"\nSummary saved to {output_path}")


def main():

    if len(sys.argv) != 2:
        print("Usage: python3 batch_scanner.py <directory_path>")
        sys.exit(1)

    directory_path = sys.argv[1]

    if not os.path.isdir(directory_path):
        print("Invalid directory path.")
        sys.exit(1)

    scanner = BatchScanner(directory_path)
    scanner.scan_all_documents()


if __name__ == "__main__":
    main()

#!/usr/bin/env python3

import re
from collections import Counter

class LogParser:
    def __init__(self):
        self.suspicious_patterns = [
            r'failed password',
            r'authentication failure',
            r'invalid user',
            r'permission denied',
            r'segmentation fault'
        ]

    def parse_syslog_line(self, line):
        pattern = r'(\w{3}\s+\d+\s+\d+:\d+:\d+)\s+(\S+)\s+([^:]+):\s+(.*)'
        match = re.match(pattern, line)
        if not match:
            return None

        return {
            'timestamp': match.group(1),
            'hostname': match.group(2),
            'process': match.group(3),
            'message': match.group(4)
        }

    def is_suspicious(self, message):
        message = message.lower()
        for pattern in self.suspicious_patterns:
            if re.search(pattern, message):
                return True, pattern
        return False, None

    def analyze_log_file(self, filepath):
        suspicious_entries = []
        process_counter = Counter()
        total_lines = 0

        with open(filepath, "r", errors="ignore") as f:
            for line in f:
                total_lines += 1
                parsed = self.parse_syslog_line(line)
                if not parsed:
                    continue

                process_counter[parsed['process']] += 1
                is_susp, pattern = self.is_suspicious(parsed['message'])
                if is_susp:
                    suspicious_entries.append(parsed)

        return {
            'total_lines': total_lines,
            'suspicious_count': len(suspicious_entries),
            'suspicious_entries': suspicious_entries[:10],
            'process_counter': process_counter
        }

def main():
    parser = LogParser()
    results = parser.analyze_log_file("/var/log/syslog")

    print("Total log lines:", results['total_lines'])
    print("Suspicious entries:", results['suspicious_count'])
    print("Top processes:")
    for proc, count in results['process_counter'].most_common(5):
        print(proc, count)

    print("=== Log Analysis Complete ===")

if __name__ == "__main__":
    main()

#!/bin/bash

# ===============================
# LAB 6: LINUX EVENT LOG ANALYSIS
# ===============================

# ---- Task 1: Explore Logging Architecture ----

cd /var/log
ls -lh

sudo tail -20 /var/log/syslog
sudo tail -20 /var/log/auth.log
sudo journalctl -n 20 --no-pager

# ---- Create Working Directory ----

mkdir -p ~/malware_lab
cd ~/malware_lab
pwd

# ---- Generate Sample Log Activity ----

ping -c 3 8.8.8.8

sudo logger "Test security event for malware detection lab"

sudo su - testuser 2>/dev/null || true

sudo tail -5 /var/log/syslog

# ---- Task 2: Extract and Filter Log Data ----

sudo grep "$(date '+%b %e')" /var/log/syslog > ~/malware_lab/today_logs.txt
wc -l ~/malware_lab/today_logs.txt

sudo grep -Ei "failed|failure|denied" /var/log/auth.log > ~/malware_lab/auth_failures.txt
wc -l ~/malware_lab/auth_failures.txt

sudo grep -Ei "error|warning" /var/log/syslog | tail -30 > ~/malware_lab/errors.txt
wc -l ~/malware_lab/errors.txt

head -5 auth_failures.txt

# ---- Create Bash Log Analysis Script ----

nano analyze_logs.sh
chmod +x analyze_logs.sh
./analyze_logs.sh

ls -lh results/

# ---- Task 3: Python Log Parser ----

nano log_parser.py
chmod +x log_parser.py
python3 log_parser.py

sudo grep -Ei "failed password|invalid user|segmentation fault" /var/log/syslog | head

# ---- Task 4: Anomaly Detection ----

nano anomaly_detector.py
chmod +x anomaly_detector.py
python3 anomaly_detector.py

ls -lh malware_report.json
cat malware_report.json

# ---- Real-Time Monitoring ----

nano realtime_monitor.py
chmod +x realtime_monitor.py
python3 realtime_monitor.py

# ---- Generate Live Test Event (Run in separate terminal) ----

sudo su - invaliduser 2>/dev/null || true

# ---- Re-test anomaly detection ----

python3 anomaly_detector.py
python3 realtime_monitor.py
